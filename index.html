<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tau Chapter Centennial Homecoming</title>
  <meta name="description" content="Register for the Tau Chapter Centennial Homecoming. Choose a sponsorship level, pay, and confirm." />
  <meta property="og:title" content="Tau Chapter Centennial Homecoming" />
  <meta property="og:description" content="Celebrate 100 years — Brotherhood • Scholarship • Service" />
  <meta property="og:image" content="assets/tau100-4.jpg" />
  <meta name="twitter:card" content="summary_large_image" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --pbs-royal:#19468D; --pbs-royal-dark:#13386a; --sigma-gray:#BCBEBE; }
    .card { border-radius:1rem; box-shadow:0 8px 24px rgba(0,0,0,0.08); }
    .focus-ring:focus-visible { outline:2px solid #19468D; outline-offset:2px; }
    body.dark { background:#0b1220; color:#e6edf3; }
    .tiers-scroll { display:flex; gap:1rem; overflow-x:auto; scroll-snap-type:x mandatory; padding-bottom:.25rem; }
    .tiers-scroll > label { min-width: 85%; scroll-snap-align:center; }
    @media (min-width: 768px) {
      .tiers-scroll { display:grid; overflow:visible; grid-template-columns: repeat(3, 1fr); }
      .tiers-scroll > label { min-width: auto; }
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <!-- Sticky mobile action bar -->
  <div class="fixed bottom-0 inset-x-0 z-40 md:hidden">
    <div class="mx-auto max-w-md">
      <div class="m-3 p-2 rounded-xl bg-white shadow-lg border border-[var(--sigma-gray)] flex gap-2">
        <a href="#register" class="flex-1 text-center px-4 py-3 rounded-lg bg-[var(--pbs-royal)] text-white font-semibold">Register</a>
        <a href="#donate" class="flex-1 text-center px-4 py-3 rounded-lg bg-white border font-semibold">Donate</a>
      </div>
    </div>
  </div>

  <!-- HERO -->
  <header class="relative bg-white/70 backdrop-blur ring-1 ring-[var(--sigma-gray)]">
    <div class="relative max-w-6xl mx-auto px-4 py-12 sm:py-16">
      <div class="flex items-center justify-between gap-4">
        <div>
          <h1 class="text-3xl sm:text-5xl font-extrabold tracking-tight">Tau Chapter Centennial Homecoming</h1>
          <p class="text-lg sm:text-xl mt-2 font-medium">Celebrating 100 Years • 1925–2025</p>
          <p id="marquee" class="mt-2 text-[var(--pbs-royal)] font-semibold">Brotherhood</p>
        </div>
        <button id="darkToggle" class="hidden sm:inline-flex px-3 py-2 rounded-lg border bg-white focus-ring" aria-label="Toggle dark mode">🌙</button>
      </div>
      <div class="mt-6 flex flex-wrap items-center gap-3">
        <a href="#register" class="px-5 py-3 bg-[var(--pbs-royal)] hover:bg-[var(--pbs-royal-dark)] text-white rounded-xl shadow font-semibold">Register</a>
        <a href="#schedule" class="px-5 py-3 bg-white text-slate-900 rounded-xl shadow border border-[var(--sigma-gray)] font-semibold">See Schedule</a>
        <a href="#donate" class="px-5 py-3 bg-white text-slate-900 rounded-xl shadow border border-[var(--sigma-gray)] font-semibold">Donate</a>
      </div>
    </div>
  </header>

  <!-- 100 Years of Tau -->
  <section id="timeline" class="max-w-6xl mx-auto px-4 py-12">
    <h2 class="text-2xl sm:text-3xl font-extrabold">100 Years of Tau Chapter</h2>
    <div class="mt-6 grid md:grid-cols-3 gap-6">
      <figure class="card bg-white rounded-2xl p-6 ring-1 ring-[var(--sigma-gray)]">
        <img src="assets/tau100-1.jpg" loading="lazy" alt="Brotherhood" class="rounded-xl w-full h-48 object-cover" width="640" height="384" />
        <figcaption class="mt-3 text-sm text-slate-700"><strong>Brotherhood</strong> — A bond unlike any other.</figcaption>
      </figure>
      <figure class="card bg-white rounded-2xl p-6 ring-1 ring-[var(--sigma-gray)]">
        <img src="assets/tau100-3.jpg" loading="lazy" alt="Scholarship" class="rounded-xl w-full h-48 object-cover" width="640" height="384" />
        <figcaption class="mt-3 text-sm text-slate-700"><strong>Scholarship</strong> — A century of academic success.</figcaption>
      </figure>
      <figure class="card bg-white rounded-2xl p-6 ring-1 ring-[var(--sigma-gray)]">
        <img src="assets/charter members.jpg" loading="lazy" alt="Service" class="rounded-xl w-full h-48 object-cover" width="640" height="384" />
        <figcaption class="mt-3 text-sm text-slate-700"><strong>Service</strong> — Committed to servicing Louisville since 1925.</figcaption>
      </figure>
    </div>
  </section>

  <!-- SCHEDULE -->
  <section id="schedule" class="max-w-6xl mx-auto px-4 py-12">
    <h2 class="text-2xl sm:text-3xl font-extrabold">Weekend Schedule</h2>
    <div class="mt-6 grid md:grid-cols-3 gap-6">
      <!-- Friday Social -->
      <div class="card bg-white rounded-2xl p-6 ring-1 ring-[var(--sigma-gray)]">
        <h3 class="text-xl font-bold">Friday, October 24 • Social Gathering</h3>
        <ul class="mt-3 text-sm text-slate-700 list-disc list-inside">
          <li>Time: 5:00–6:30 PM (near Brown Theater, TBA)</li>
          <li>We’ll enter the Stepshow together</li>
        </ul>
        <div class="mt-2 text-sm">
          <a href="https://calendar.google.com/calendar/render?action=TEMPLATE&text=Tau%20Chapter%20Social%20Gathering&dates=20250919T220000Z/20250919T233000Z&details=Meet%20near%20Brown%20Theater%2C%20enter%20Stepshow%20together&location=Brown%20Theater%20area"
             target="_blank" class="underline text-[var(--pbs-royal)]">Add to Google Calendar</a>
        </div>
      </div>

      <!-- Friday Stepshow -->
      <div class="card bg-white rounded-2xl p-6 ring-1 ring-[var(--sigma-gray)]">
        <h3 class="text-xl font-bold">Friday, October 24 • Homecoming Stepshow</h3>
        <div class="mt-2 text-sm">
<img src="assets/tau100-4.jpg" loading="lazy" alt="Stepshow" class="rounded-xl w-full h-40 object-cover mt-2" width="640" height="320" />
          <a href="https://tickets.kentuckyperformingarts.org/25109"
     target="_blank" class="underline text-[var(--pbs-royal)] font-semibold">
    Buy Tickets via Kentucky Performing Arts
  </a>
  <p class="mt-1 text-gray-600 italic">
    Use promo code <strong>MIGHTY25</strong> at checkout for discounted tickets.
  </p>
</div>

        <ul class="mt-3 text-sm text-slate-700 list-disc list-inside">
          <li>Time: 7:00 PM</li>
          <li>Venue: Brown Theater (Kentucky Performing Arts)</li>
        </ul>
        <div class="mt-2 text-sm">
          <a href="https://calendar.google.com/calendar/render?action=TEMPLATE&text=Tau%20Chapter%20Homecoming%20Stepshow&dates=20250919T230000Z/20250920T010000Z&details=Official%20stepshow%20at%20Brown%20Theater&location=Brown%20Theater%2C%20315%20W%20Broadway%2C%20Louisville%2C%20KY"
             target="_blank" class="underline text-[var(--pbs-royal)]">Add to Google Calendar</a>
        </div>
      </div>

      <!-- Saturday Tailgate -->
      <div class="card bg-white rounded-2xl p-6 ring-1 ring-[var(--sigma-gray)]">
        <h3 class="text-xl font-bold">Saturday, October 25 • Tailgate</h3>
        <div class="flex items-center gap-3 mt-2">
          <img src="assets/uofl-bc.jpg" alt="UofL vs Boston College" loading="lazy" class="rounded-xl w-full h-40 object-cover mt-2" width="640" height="320" />
        </div>
        <ul class="mt-3 text-sm text-slate-700 list-disc list-inside">
          <li>Time: 12:00–3:00 PM</li>
          <li>Location: Boy Scout Lot — see the <strong>X</strong> on the map below</li>
          <li>Football game ticket not included</li>
        </ul>
        <div class="mt-2 text-sm">
          <a href="https://calendar.google.com/calendar/render?action=TEMPLATE&text=Tau%20Chapter%20Tailgate&dates=20250920T170000Z/20250920T200000Z&details=Tailgate%20near%20stadium&location=Louisville%20KY"
             target="_blank" class="underline text-[var(--pbs-royal)]">Add to Google Calendar</a>
        </div>
        <div class="mt-4 rounded-2xl border border-[var(--sigma-gray)] p-3 bg-white">
          <img src="assets/tailgate.png" alt="Tailgate Location Map — Boy Scout Lot (X marks the spot)"
               class="rounded-xl w-full object-contain" style="max-height:520px" />
          <p class="text-sm text-center mt-2">
            Location: <strong>Boy Scout Lot</strong> — see the <strong>X</strong> on the map.
            <br />
            <a class="underline" href="assets/tailgate.png" target="_blank" rel="noopener">View larger map</a>
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- SUPPORT / DONATE -->
  <section id="donate" class="max-w-6xl mx-auto px-4 py-12">
    <h2 class="text-2xl sm:text-3xl font-extrabold">Support Tau Chapter</h2>
    <p class="text-slate-600 mt-2">Remaining proceeds support current undergraduate brothers.</p>
    <div class="mt-4 flex flex-wrap items-center gap-3">
      <a href="https://cash.app/$UofLSigmas" target="_blank" class="px-5 py-3 bg-white rounded-xl border font-semibold shadow">Donate via Cash App</a>
    </div>
  </section>

  <!-- REGISTRATION -->
  <section id="register" class="max-w-6xl mx-auto px-4 py-12">
    <div class="bg-white rounded-2xl p-6 ring-1 ring-[var(--sigma-gray)] card">
      <h2 class="text-2xl sm:text-3xl font-extrabold">Register</h2>
      <p class="text-slate-600 mt-2">Choose a sponsorship level, complete your info, then pay via Venmo (preferred), Cash App, or PayPal and confirm payment.</p>

      <!-- Sponsorship tiers -->
      <div id="tiers" class="mt-6 tiers-scroll">
        <!-- $100 -->
        <label class="group block rounded-2xl border-2 border-[var(--sigma-gray)] p-4 cursor-pointer hover:border-[var(--pbs-royal)] bg-white">
          <div class="flex items-start justify-between gap-2">
            <div>
              <div class="text-xl font-extrabold">$100</div>
              <div class="font-semibold">Centennial Sponsorship</div>
              <div class="mt-1 text-sm text-slate-600 flex flex-col gap-1">
                <span>⭐ Special recognition from TAU</span>
                <span>🍔 Tailgate included</span>
                <span>🎽 T-shirt included</span>
              </div>
            </div>
            <input type="radio" name="tier" value="100|Centennial Sponsorship" class="mt-1 h-5 w-5" checked />
          </div>
          <div class="mt-2 inline-flex items-center text-xs font-semibold text-white bg-[var(--pbs-royal)] px-2 py-1 rounded">Most Impactful</div>
        </label>

        <!-- $50 -->
        <label class="group block rounded-2xl border-2 border-[var(--sigma-gray)] p-4 cursor-pointer hover:border-[var(--pbs-royal)] bg-white">
          <div class="flex items-start justify-between gap-2">
            <div>
              <div class="text-xl font-extrabold">$50</div>
              <div class="font-semibold">Tailgate + T-shirt</div>
              <div class="mt-1 text-sm text-slate-600 flex flex-col gap-1">
                <span>🍔 Tailgate included</span>
                <span>🎽 T-shirt included</span>
              </div>
            </div>
            <input type="radio" name="tier" value="50|Tailgate + T-shirt" class="mt-1 h-5 w-5" />
          </div>
        </label>

        <!-- $25 -->
        <label class="group block rounded-2xl border-2 border-[var(--sigma-gray)] p-4 cursor-pointer hover:border-[var(--pbs-royal)] bg-white">
          <div class="flex items-start justify-between gap-2">
            <div>
              <div class="text-xl font-extrabold">$25</div>
              <div class="font-semibold">Tailgate only</div>
              <div class="mt-1 text-sm text-slate-600 flex flex-col gap-1">
                <span>🍔 Tailgate included</span>
                <span>🎟 Football game ticket not included</span>
              </div>
            </div>
            <input type="radio" name="tier" value="25|Tailgate only" class="mt-1 h-5 w-5" />
          </div>
        </label>
      </div>

      <form id="regForm" class="mt-6 grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium">Full Name</label>
          <input name="name" required class="mt-1 w-full rounded-xl border-[var(--sigma-gray)] focus:outline-none focus:ring-2 focus:ring-[var(--pbs-royal)]" />
        </div>
        <div>
          <label class="block text-sm font-medium">Email</label>
          <input type="email" name="email" required class="mt-1 w-full rounded-xl border-[var(--sigma-gray)] focus:outline-none focus:ring-2 focus:ring-[var(--pbs-royal)]" />
        </div>
        <div>
          <label class="block text-sm font-medium">Phone</label>
          <input type="tel" name="phone" required class="mt-1 w-full rounded-xl border-[var(--sigma-gray)] focus:outline-none focus:ring-2 focus:ring-[var(--pbs-royal)]" />
        </div>
        <div>
          <label class="block text-sm font-medium">Year Joined the Fraternity</label>
          <input type="number" name="yearJoined" required min="1900" max="2100" class="mt-1 w-full rounded-xl border-[var(--sigma-gray)] focus:outline-none focus:ring-2 focus:ring-[var(--pbs-royal)]" />
        </div>
        <div>
          <label class="block text-sm font-medium">T-Shirt Size</label>
          <select name="tshirtSize" required class="mt-1 w-full rounded-xl border-[var(--sigma-gray)] focus:outline-none focus:ring-2 focus:ring-[var(--pbs-royal)]">
            <option value="M">M</option><option value="L">L</option><option value="XL">XL</option>
            <option value="2XL">2XL</option><option value="3XL">3XL</option><option value="4XL">4XL</option><option value="5XL">5XL</option>
          </select>
        </div>

        <!-- Honeypot -->
        <div class="hidden" style="display:none!important;">
          <label>Website</label>
          <input name="website" tabindex="-1" autocomplete="off" />
        </div>

        <!-- Public roster opt-in -->
        <label class="flex items-center gap-2 md:col-span-2 text-sm">
          <input type="checkbox" name="optInPublic" class="rounded" checked />
          I’m OK with my name appearing on the public “Registered Attendees” list.
        </label>

        <!-- Dynamic selection summary -->
        <p id="tierSummary" class="md:col-span-2 text-sm text-slate-700">Selected: <strong>$100 – Centennial Sponsorship</strong></p>

        <div class="md:col-span-2 flex items-center justify-between gap-4">
          <div class="text-sm text-slate-600">Remaining proceeds support current undergraduate brothers.</div>
          <button type="submit" id="submitBtn" class="px-5 py-3 bg-[var(--pbs-royal)] hover:bg-[var(--pbs-royal-dark)] text-white rounded-xl shadow font-semibold">Continue</button>
        </div>
        <p id="formMsg" class="md:col-span-2 text-sm text-slate-600"></p>
      </form>

<!-- Confirmation panel (shown after submit) -->
<div id="confirmPanel" class="hidden mt-6 rounded-xl border p-4 bg-slate-50">
  <h3 class="font-bold">Choose a payment option, then confirm</h3>
  <p class="text-sm mt-2">
    Please send <span id="payAmount" class="font-semibold">$100</span> via one of the options below,
    then click <em>Confirm Payment</em>.
  </p>
  <ul class="mt-2 list-disc list-inside text-sm space-y-1">
    <li>
      Venmo (preferred): <a id="payVenmo" href="https://venmo.com/morehead" target="_blank" class="underline">venmo.com/morehead</a>
    </li>
    <li>
      Cash App: <a id="payCashApp" href="https://cash.app/$Morehead" target="_blank" class="underline">cash.app/$Morehead</a>
    </li>
    <li>
      PayPal: <a id="payPayPal" href="https://paypal.me/morehead" target="_blank" class="underline">paypal.me/morehead</a>
    </li>
  </ul>

  <div class="mt-3 text-sm">
    Your payment code:
    <code id="paymentCode" class="px-2 py-1 bg-white rounded border">TBD</code>
    <button id="copyCode" class="ml-2 px-2 py-1 text-xs border rounded bg-white">Copy</button>

    <label class="flex items-center gap-2 mt-3">
      <input id="paidCheck" type="checkbox">
      <span>I paid</span>
    </label>
  </div>

  <div class="mt-3 sticky bottom-2">
    <a id="confirmLink"
       href="#"
       class="px-4 py-2 rounded-lg bg-[var(--pbs-royal)] text-white font-semibold inline-block opacity-50 pointer-events-none"
       aria-disabled="true">
      Confirm Payment
    </a>
  </div>

  <p class="text-xs text-slate-500 mt-2">
    If you close this page, you can use the emailed link (if enabled) to confirm later.
  </p>
</div>

  </section>

  <!-- ROSTER -->
  <section id="roster" class="max-w-6xl mx-auto px-4 py-12">
    <div class="flex items-center justify-between">
      <h2 class="text-2xl sm:text-3xl font-extrabold">Registered Attendees</h2>
      <button id="refreshBtn" class="px-4 py-2 rounded-xl border bg-white shadow text-sm">Refresh</button>
    </div>
    <div id="rosterWrap" class="mt-6 grid md:grid-cols-2 gap-6"></div>
  </section>

  <!-- Footer micro-nav + Donate + QR + Admin -->
  <footer class="border-t">
    <div class="max-w-6xl mx-auto px-4 py-10 text-sm">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <nav class="flex gap-4">
          <a href="#register" class="underline">Register</a>
          <a href="#schedule" class="underline">Schedule</a>
          <a href="#donate" class="underline">Donate</a>
          <a href="#roster" class="underline">Roster</a>
        </nav>
        <div class="flex items-center gap-3">
          <a href="https://cash.app/$UofLSigmas" target="_blank" class="px-3 py-2 rounded-lg border bg-white">Donate via Cash App</a>
          <img src="https://api.qrserver.com/v1/create-qr-code/?size=110x110&data=https%3A%2F%2Fcash.app%2F%24UofLSigmas" alt="Donate QR" class="w-14 h-14 rounded" />
        </div>
      </div>

      <details class="mt-6">
        <summary class="cursor-pointer font-semibold">Admin</summary>
        <div class="mt-3 flex flex-wrap items-center gap-3">
          <input id="adminKey" type="password" placeholder="Passcode" class="rounded border px-3 py-2" />
          <button id="csvBtn" class="px-3 py-2 rounded border bg-white">Download CSV</button>
          <button id="totalsBtn" class="px-3 py-2 rounded border bg-white">Totals</button>
          <button id="pendingBtn" class="px-3 py-2 rounded border bg-white">Load Pending</button>
        </div>
        <div id="pendingList" class="mt-4 grid md:grid-cols-2 gap-4"></div>
        <pre id="totalsOut" class="mt-3 text-xs text-slate-600"></pre>

        <!-- Minimal manage-registrants UI (stays inside Admin) -->
        <div class="mt-6">
          <button id="manageBtn" class="px-3 py-2 rounded border bg-white">Manage Registrants</button>
          <div id="manageWrap" class="mt-3 hidden">
            <div class="text-xs text-slate-500">Tip: “Soft delete” hides from roster (reversible). “Hard delete” removes permanently.</div>
            <div class="overflow-x-auto mt-2">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="text-left border-b">
                    <th class="py-2 pr-3">Name</th>
                    <th class="py-2 pr-3">Email</th>
                    <th class="py-2 pr-3">Year</th>
                    <th class="py-2 pr-3">Pkg</th>
                    <th class="py-2 pr-3">Deleted</th>
                    <th class="py-2">Actions</th>
                  </tr>
                </thead>
                <tbody id="manageBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </details>

      <div class="mt-6 text-slate-500">© 2025 Tau Chapter Centennial Homecoming</div>
    </div>
  </footer>

  <script>
    // Dark mode toggle with persistence
    const darkToggle=document.getElementById('darkToggle');
    if(localStorage.getItem('tau.dark')==='1'){ document.body.classList.add('dark'); }
    darkToggle?.addEventListener('click',()=>{
      document.body.classList.toggle('dark');
      localStorage.setItem('tau.dark', document.body.classList.contains('dark') ? '1' : '0');
    });

    // Marquee
    (function(){ const phrases=["Brotherhood","Scholarship","Service"]; let i=0;
      setInterval(()=>{ i=(i+1)%phrases.length; document.getElementById('marquee').textContent=phrases[i]; }, 2500);
    })();

    // Tier summary + amount binding
    function currentTier(){ const c=document.querySelector('input[name="tier"]:checked'); if(!c) return {amount:100,name:"Centennial Sponsorship"}; const [a,n]=c.value.split('|'); return {amount:Number(a), name=n}; }
    function updateSummary(){ const t=currentTier(); document.getElementById('tierSummary').innerHTML='Selected: <strong>$'+t.amount+' – '+t.name+'</strong>'; }
    document.querySelectorAll('input[name="tier"]').forEach(r=>r.addEventListener('change',updateSummary)); updateSummary();

    // Roster helpers
    const rosterWrap=document.getElementById('rosterWrap'); const refreshBtn=document.getElementById('refreshBtn');
    function groupByDecade(list){ const g={}; for(const r of list){ if(r.optInPublic===false) continue; const y=Number(r.yearJoined||0); const d=Math.floor(y/10)*10; const k=d+'s'; g[k]=g[k]||{}; g[k][y]=g[k][y]||[]; g[k][y].push(r);} return g; }
    function renderRoster(list){ const g=groupByDecade(list); const decades=Object.keys(g).sort((a,b)=>parseInt(b)-parseInt(a)); rosterWrap.innerHTML=''; if(!decades.length){ rosterWrap.innerHTML='<div class="text-slate-600">No registrations yet.</div>'; return;} for(const d of decades){ const years=Object.keys(g[d]).map(Number).sort((a,b)=>a-b); const col=document.createElement('div'); col.className='bg-white rounded-2xl p-6 ring-1 ring-[var(--sigma-gray)] card'; col.innerHTML='<h3 class="text-xl font-bold">'+d+'</h3>'; for(const y of years){ const items=g[d][y].sort((a,b)=>a.name.localeCompare(b.name)).map(p=>'<li class="py-1 flex gap-2 items-center"><span class="font-medium">'+p.name+'</span> <span class="text-xs text-slate-500">('+y+(p.tshirtSize?', '+p.tshirtSize:'')+')</span></li>').join(''); col.insertAdjacentHTML('beforeend','<div class="mt-4"><div class="text-sm font-semibold">'+y+'</div><ul class="mt-1 text-sm">'+items+'</ul></div>'); } rosterWrap.appendChild(col);} }
    async function loadRoster(){ rosterWrap.innerHTML='<div class="text-slate-600">Loading roster…</div>'; try{ const r=await fetch('/.netlify/functions/list_registrants',{headers:{'cache-control':'no-cache'}}); const j=await r.json(); renderRoster(j.registrants||[]);} catch(e){ rosterWrap.innerHTML='<div class="text-slate-600">Unable to load roster.</div>'; } }
    refreshBtn.addEventListener('click',loadRoster); loadRoster();

    // Form submit -> create pending & show confirm
    const form=document.getElementById('regForm'); const formMsg=document.getElementById('formMsg');
    const confirmPanel=document.getElementById('confirmPanel'); const payAmount=document.getElementById('payAmount');
    const paymentCodeEl=document.getElementById('paymentCode'); const copyCode=document.getElementById('copyCode'); const confirmLink=document.getElementById('confirmLink');
    const paidCheck=document.getElementById('paidCheck');

    function syncConfirmBtn(){
      if (!confirmLink) return;
      const on = !!(paidCheck && paidCheck.checked);
      confirmLink.classList.toggle('opacity-50', !on);
      confirmLink.classList.toggle('pointer-events-none', !on);
      confirmLink.setAttribute('aria-disabled', on ? 'false' : 'true');
    }
    paidCheck?.addEventListener('change', syncConfirmBtn); syncConfirmBtn();

    document.getElementById('copyCode')?.addEventListener('click',()=>{
      const code=paymentCodeEl.textContent;
      navigator.clipboard.writeText(code);
      document.getElementById('copyCode').textContent='Copied';
      setTimeout(()=>document.getElementById('copyCode').textContent='Copy',1200);
    });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault(); formMsg.textContent='Submitting…';
      const t=currentTier(); payAmount.textContent='$'+t.amount; const data=new FormData(form);
      const payload={ name:data.get('name'), email:data.get('email'), phone:data.get('phone'), yearJoined:Number(data.get('yearJoined')), tshirtSize:data.get('tshirtSize'), website:data.get('website'), optInPublic:data.get('optInPublic')==='on', packageName:t.name, packageAmount:t.amount };
      try{
        const r=await fetch('/.netlify/functions/submit_manual_registration',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        const text=await r.text();
        if(!r.ok){ formMsg.textContent='Submit failed: '+text; return; }
        let j={}; try{ j=JSON.parse(text);}catch{ formMsg.textContent='Submit response not JSON: '+text; return; }
        paymentCodeEl.textContent=j.paymentCode||'UNKNOWN'; confirmLink.href=j.confirmUrl||'#'; confirmPanel.classList.remove('hidden'); formMsg.textContent='';
        confirmPanel.scrollIntoView({behavior:'smooth', block:'center'});
      } catch(err){ formMsg.textContent='Error: '+(err?.message||String(err)); }
    });

    // Admin manage (minimal duplicates control)
    const manageBtn = document.getElementById('manageBtn');
    const manageWrap = document.getElementById('manageWrap');
    const manageBody = document.getElementById('manageBody');

    async function loadManage() {
      manageBody.innerHTML = '<tr><td colspan="6" class="py-3 text-slate-500">Loading…</td></tr>';
      try {
        const r = await fetch('/.netlify/functions/list_registrants', { headers: {'cache-control':'no-cache'} });
        const j = await r.json();
        const arr = (j.registrants || []).slice().sort((a,b)=>String(a.name||'').localeCompare(b.name||''));
        if (!arr.length) { manageBody.innerHTML = '<tr><td colspan="6" class="py-3 text-slate-500">No registrants yet.</td></tr>'; return; }
        manageBody.innerHTML = arr.map(row => {
          const key = row.key || '';
          const del = row.deleted ? 'Yes' : 'No';
          return `<tr class="border-b">
            <td class="py-2 pr-3">${row.name||''}</td>
            <td class="py-2 pr-3">${row.email||''}</td>
            <td class="py-2 pr-3">${row.yearJoined||''}</td>
            <td class="py-2 pr-3">${row.packageName||''} $${row.packageAmount||0}</td>
            <td class="py-2 pr-3">${del}</td>
            <td class="py-2 space-x-2">
              <button class="px-2 py-1 rounded border bg-white" onclick="softDel('${key}', ${row.deleted? 'false':'true'})">${row.deleted?'Restore':'Soft delete'}</button>
              <button class="px-2 py-1 rounded border bg-white" onclick="hardDel('${key}')">Hard delete</button>
            </td>
          </tr>`;
        }).join('');
      } catch (e) {
        manageBody.innerHTML = `<tr><td colspan="6" class="py-3 text-rose-600">Error loading: ${e?.message||e}</td></tr>`;
      }
    }

    manageBtn?.addEventListener('click', () => {
      manageWrap.classList.toggle('hidden');
      if (!manageWrap.classList.contains('hidden')) loadManage();
    });

    window.softDel = async (key, setDel) => {
      const pass = document.getElementById('adminKey')?.value || '';
      if (!pass) return alert('Enter Admin passcode first.');
      try {
        const r = await fetch('/.netlify/functions/update_registrant', {
          method:'POST',
          headers:{ 'content-type':'application/json', 'x-admin-key': pass },
          body: JSON.stringify({ id:key, patch: { deleted: !!setDel } })
        });
        const j = await r.json().catch(()=>({}));
        if (!r.ok) throw new Error(j.error||('HTTP '+r.status));
        await loadManage();
        await loadRoster();
      } catch(e) {
        alert('Update failed: '+(e?.message||e));
      }
    };

    window.hardDel = async (key) => {
      const pass = document.getElementById('adminKey')?.value || '';
      if (!pass) return alert('Enter Admin passcode first.');
      if (!confirm('Permanently remove this record?')) return;
      try {
        const r = await fetch('/.netlify/functions/delete_registrant', {
          method:'POST',
          headers:{ 'content-type':'application/json', 'x-admin-key': pass },
          body: JSON.stringify({ id:key })
        });
        const j = await r.json().catch(()=>({}));
        if (!r.ok) throw new Error(j.error||('HTTP '+r.status));
        await loadManage();
        await loadRoster();
      } catch(e) {
        alert('Delete failed: '+(e?.message||e));
      }
    };
  </script>
  <script src="assets/js/submit-handler.js"></script>
</body>
</html>
