<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tau Chapter Centennial Homecoming</title>

  <!-- SEO / Social share -->
  <meta name="description" content="Tau Chapter Centennial Homecoming — register, pay, and join the celebration." />
  <meta property="og:title" content="Tau Chapter Centennial Homecoming" />
  <meta property="og:description" content="Celebrate 100 years • Register today." />
  <meta property="og:image" content="assets/PBS%20100.jpg" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- Fonts & Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet" />
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    :root { --pbs-royal:#19468D; --pbs-royal-dark:#13386a; --sigma-gray:#BCBEBE; --sigma-black:#1F1E1E; }
  </style>

  <!-- JSON-LD Event schema for Stepshow -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Event",
    "name": "Tau Chapter Homecoming Stepshow",
    "startDate": "2025-09-19T19:00:00-05:00",
    "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
    "eventStatus": "https://schema.org/EventScheduled",
    "location": {
      "@type": "Place",
      "name": "Brown Theater",
      "address": "315 W Broadway, Louisville, KY 40202"
    },
    "image": ["https://tau100.netlify.app/assets/PBS%20100.jpg"],
    "description": "Official homecoming stepshow for Tau Chapter Centennial.",
    "offers": {
      "@type": "Offer",
      "url": "https://tickets.kentuckyperformingarts.org/25109",
      "price": "0",
      "priceCurrency": "USD",
      "availability": "https://schema.org/InStock",
      "validFrom": "2025-09-20T00:00:00-05:00"
    },
    "organizer": {"@type": "Organization", "name": "Tau Chapter"}
  }
  </script>
</head>
<body class="bg-slate-50 text-slate-900">

  <!-- HERO -->
  <header class="relative overflow-hidden">
    <div class="absolute inset-0 opacity-10">
      <img src="assets/PBS%20100.jpg" class="w-full h-full object-cover" alt="Centennial Collage" />
    </div>
    <div class="relative max-w-6xl mx-auto px-4 py-16">
      <div class="flex items-center gap-4">
        <img src="assets/Tau 1925.jpg" alt="Tau 1925" class="w-16 h-16 object-cover rounded-full ring-2 ring-white shadow" />
        <div>
          <h1 class="text-3xl sm:text-5xl font-extrabold tracking-tight">Tau Chapter Centennial Homecoming</h1>
          <p class="text-lg sm:text-xl mt-2 font-medium">Celebrating 100 Years • 1925–2025</p>
        </div>
      </div>
      <p class="mt-6 max-w-3xl text-slate-700">Join brothers, family, and friends for a historic weekend of fellowship, history, and celebration.</p>
      <div class="mt-6 flex flex-wrap items-center gap-3">
        <a href="#register" class="px-5 py-3 bg-[var(--pbs-royal)] hover:bg-[var(--pbs-royal-dark)] text-white rounded-xl shadow font-semibold">Register & Pay $100</a>
        <a href="#schedule" class="px-5 py-3 bg-white text-slate-900 rounded-xl shadow border border-[var(--sigma-gray)] font-semibold">See Schedule</a>
      </div>
    </div>
  </header>

  <!-- 100 Years of Tau Chapter (keep as-is per request) -->
  <section id="timeline" class="max-w-6xl mx-auto px-4 py-12">
    <h2 class="text-2xl sm:text-3xl font-extrabold relative pb-2 after:content-[''] after:absolute after:left-0 after:-bottom-1 after:w-24 after:h-1 after:bg-[var(--pbs-royal)]">100 Years of Tau Chapter</h2>
    <div class="mt-6 grid md:grid-cols-3 gap-6">
      <figure class="bg-white rounded-2xl shadow p-6 ring-1 ring-[var(--sigma-gray)]">
        <img src="assets/Tau 1925.jpg" alt="Tau Chapter 1925" class="rounded-xl object-cover w-full h-48" />
        <figcaption class="mt-3 text-sm text-slate-600"><strong>1925</strong> – Founding era.</figcaption>
      </figure>
      <figure class="bg-white rounded-2xl shadow p-6 ring-1 ring-[var(--sigma-gray)]">
        <img src="assets/PBS 100.jpg" alt="PBS 100" class="rounded-xl object-cover w-full h-48" />
        <figcaption class="mt-3 text-sm text-slate-600"><strong>Milestones</strong> – A century of service, scholarship, and brotherhood.</figcaption>
      </figure>
      <figure class="bg-white rounded-2xl shadow p-6 ring-1 ring-[var(--sigma-gray)]">
        <img src="assets/charter members.jpg" alt="Charter Members" class="rounded-xl object-cover w-full h-48" />
        <figcaption class="mt-3 text-sm text-slate-600"><strong>Charter Members</strong> – The leaders who set our path.</figcaption>
      </figure>
    </div>
  </section>

  <!-- SCHEDULE / EVENTS -->
  <section id="schedule" class="max-w-6xl mx-auto px-4 py-12">
    <h2 class="text-2xl sm:text-3xl font-extrabold relative pb-2 after:content-[''] after:absolute after:left-0 after:-bottom-1 after:w-24 after:h-1 after:bg-[var(--pbs-royal)]">Weekend Schedule</h2>
    <p class="text-slate-600 mt-2">Times/locations subject to minor adjustments; check back for updates.</p>

    <div class="mt-6 grid md:grid-cols-3 gap-6">
      <!-- Friday Social Gathering -->
      <div class="bg-white rounded-2xl shadow p-6 ring-1 ring-[var(--sigma-gray)]">
        <h3 class="text-xl font-bold">Friday • Social Gathering</h3>
        <p class="mt-2 text-slate-600">Evening mixer to kick off the weekend. Connect with brothers across generations.</p>
        <ul class="mt-3 text-sm text-slate-700 list-disc list-inside">
          <li>Time: Friday 7:00–10:00 PM</li>
          <li>Venue: TBA</li>
        </ul>
      </div>

      <!-- Friday Stepshow -->
      <div class="bg-white rounded-2xl shadow p-6 ring-1 ring-[var(--sigma-gray)]">
        <h3 class="text-xl font-bold">Friday Night • Homecoming Stepshow</h3>
        <p class="mt-2 text-slate-600">Celebrate excellence and tradition at the official Stepshow.</p>
        <ul class="mt-3 text-sm text-slate-700 list-disc list-inside">
          <li>Time: Friday 7:00 PM</li>
          <li>Venue: Brown Theater (Kentucky Performing Arts)</li>
        </ul>
        <div class="mt-2 text-sm">
          <a href="https://calendar.google.com/calendar/render?action=TEMPLATE&text=Tau%20Chapter%20Homecoming%20Stepshow&dates=20250919T230000Z/20250920T010000Z&details=Official%20stepshow%20at%20Brown%20Theater&location=Brown%20Theater%2C%20315%20W%20Broadway%2C%20Louisville%2C%20KY"
             target="_blank" class="underline text-[var(--pbs-royal)]">
             Add to Google Calendar
          </a>
        </div>
        <div class="mt-4 space-y-2">
          <div class="flex flex-wrap items-center gap-3">
            <button id="kpaButton" class="px-4 py-2 rounded-xl font-semibold shadow border border-[var(--sigma-gray)] bg-white disabled:opacity-50" disabled>
              Stepshow Tickets (Available Sept 20)
            </button>
            <a href="https://maps.google.com/?q=Brown+Theater+Louisville+KY" target="_blank" rel="noopener"
               class="px-4 py-2 rounded-xl font-semibold shadow border border-[var(--sigma-gray)] bg-white hover:bg-[var(--sigma-gray)] hover:bg-opacity-20">Map</a>
          </div>
          <p id="kpaHelper" class="text-xs text-slate-500">Ticket sales open on <strong>September 20</strong>. A direct link will appear here.</p>
          <a id="kpaLink" href="#" target="_blank" rel="noopener"
             class="text-sm font-semibold text-[var(--pbs-royal)] underline hidden" style="display:none">
            Buy Stepshow Tickets →
          </a>
        </div>
      </div>

      <!-- Saturday Tailgate -->
      <div class="bg-white rounded-2xl shadow p-6 ring-1 ring-[var(--sigma-gray)]">
        <h3 class="text-xl font-bold">Saturday • Tailgate (Food & Drink Included)</h3>
        <p class="mt-2 text-slate-600">Pregame fellowship before the football game. <em>Game ticket not included.</em></p>
        <ul class="mt-3 text-sm text-slate-700 list-disc list-inside">
          <li>Time: Saturday 12:00–3:00 PM</li>
          <li>Location: TBA (near stadium)</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- REGISTRATION -->
  <section id="register" class="max-w-6xl mx-auto px-4 py-12">
    <div class="bg-white rounded-2xl shadow p-6 ring-1 ring-[var(--sigma-gray)]">
      <h2 class="text-2xl sm:text-3xl font-extrabold relative pb-2 after:content-[''] after:absolute after:left-0 after:-bottom-1 after:w-24 after:h-1 after:bg-[var(--pbs-royal)]">Register</h2>
      <p class="text-slate-600 mt-2">Complete the form below. You’ll be redirected to secure payment (Stripe) to finalize your registration.</p>

      <form id="regForm" class="mt-6 grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium">Full Name</label>
          <input name="name" required class="mt-1 w-full rounded-xl border-[var(--sigma-gray)] focus:outline-none focus:ring-2 focus:ring-[var(--pbs-royal)] focus:border-[var(--pbs-royal)]" placeholder="First Last" />
        </div>
        <div>
          <label class="block text-sm font-medium">Email</label>
          <input type="email" name="email" required class="mt-1 w-full rounded-xl border-[var(--sigma-gray)] focus:outline-none focus:ring-2 focus:ring-[var(--pbs-royal)] focus:border-[var(--pbs-royal)]" placeholder="you@example.com" />
        </div>
        <div>
          <label class="block text-sm font-medium">Phone</label>
          <input type="tel" name="phone" required class="mt-1 w-full rounded-xl border-[var(--sigma-gray)] focus:outline-none focus:ring-2 focus:ring-[var(--pbs-royal)] focus:border-[var(--pbs-royal)]" placeholder="(555) 555-5555" />
        </div>
        <div>
          <label class="block text-sm font-medium">Year Joined the Fraternity</label>
          <input type="number" name="yearJoined" required min="1900" max="2100" class="mt-1 w-full rounded-xl border-[var(--sigma-gray)] focus:outline-none focus:ring-2 focus:ring-[var(--pbs-royal)] focus:border-[var(--pbs-royal)]" placeholder="e.g., 2005" />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium">Optional Photo (JPG/PNG)</label>
          <input type="file" name="photo" accept="image/*" class="mt-1 w-full rounded-xl border-[var(--sigma-gray)]" />
        </div>

        <!-- Honeypot (spam trap) -->
        <div class="hidden" style="display:none !important;">
          <label>Website</label>
          <input name="website" tabindex="-1" autocomplete="off" />
        </div>

        <!-- Public roster opt-in -->
        <label class="flex items-center gap-2 md:col-span-2 text-sm">
          <input type="checkbox" name="optInPublic" class="rounded" checked />
          I’m OK with my name appearing on the public “Registered Attendees” list.
        </label>

        <div class="md:col-span-2 flex items-center justify-between gap-4">
          <div class="text-sm text-slate-600">Registration Fee: <span class="font-semibold">$100</span></div>
          <button type="submit" id="submitBtn" class="px-5 py-3 bg-[var(--pbs-royal)] hover:bg-[var(--pbs-royal-dark)] text-white rounded-xl shadow font-semibold">Register & Pay $100</button>
        </div>
        <p id="formMsg" class="md:col-span-2 text-sm text-slate-600"></p>
      </form>
    </div>
  </section>

  <!-- ROSTER -->
  <section id="roster" class="max-w-6xl mx-auto px-4 py-12">
    <div class="flex items-center justify-between">
      <h2 class="text-2xl sm:text-3xl font-extrabold relative pb-2 after:content-[''] after:absolute after:left-0 after:-bottom-1 after:w-24 after:h-1 after:bg-[var(--pbs-royal)]">Registered Attendees</h2>
      <button id="refreshBtn" class="px-4 py-2 rounded-xl border border-[var(--sigma-gray)] bg-white shadow text-sm">Refresh</button>
    </div>
    <p class="text-slate-600 mt-2">Grouped by decade of initiation, then by year joined.</p>
    <div id="rosterWrap" class="mt-6 grid md:grid-cols-2 gap-6"></div>
  </section>

  <!-- FAQ -->
  <section id="faq" class="max-w-6xl mx-auto px-4 py-12">
    <h2 class="text-2xl sm:text-3xl font-extrabold relative pb-2 after:content-[''] after:absolute after:left-0 after:-bottom-1 after:w-24 after:h-1 after:bg-[var(--pbs-royal)]">FAQs</h2>
    <div class="mt-6 grid md:grid-cols-2 gap-6">
      <div class="bg-white rounded-2xl shadow p-6 ring-1 ring-[var(--sigma-gray)]">
        <h3 class="font-bold">Is the football game ticket included?</h3>
        <p class="mt-2 text-slate-600">No. Tailgate includes food & drink, but <strong>game tickets are not included</strong>.</p>
      </div>
      <div class="bg-white rounded-2xl shadow p-6 ring-1 ring-[var(--sigma-gray)]">
        <h3 class="font-bold">Refunds</h3>
        <p class="mt-2 text-slate-600">Registrations are non-refundable, but you may transfer your spot by contacting the organizers.</p>
      </div>
      <div class="bg-white rounded-2xl shadow p-6 ring-1 ring-[var(--sigma-gray)]">
        <h3 class="font-bold">Accessibility</h3>
        <p class="mt-2 text-slate-600">Event venues are ADA friendly. For specific accommodations, please note in your registration or contact us.</p>
      </div>
      <div class="bg-white rounded-2xl shadow p-6 ring-1 ring-[var(--sigma-gray)]">
        <h3 class="font-bold">Dress Code</h3>
        <p class="mt-2 text-slate-600">Business casual for Friday Social; school colors for Tailgate; semi-formal for the Stepshow.</p>
      </div>
    </div>
  </section>

  <!-- LODGING -->
  <section id="lodging" class="max-w-6xl mx-auto px-4 py-12">
    <h2 class="text-2xl sm:text-3xl font-extrabold relative pb-2 after:content-[''] after:absolute after:left-0 after:-bottom-1 after:w-24 after:h-1 after:bg-[var(--pbs-royal)]">Lodging</h2>
    <p class="text-slate-600 mt-2">We recommend booking early. Hotel block info and links will appear here if available.</p>
    <ul class="mt-4 list-disc list-inside text-slate-700">
      <li>Downtown hotels near Brown Theater and the stadium</li>
      <li>Include your group name at booking (if a block is arranged)</li>
      <li>Watch this space for discount codes and cutoff dates</li>
    </ul>
  </section>

  <!-- MEMORY WALL -->
  <section id="memories" class="max-w-6xl mx-auto px-4 py-12">
    <h2 class="text-2xl sm:text-3xl font-extrabold relative pb-2 after:content-[''] after:absolute after:left-0 after:-bottom-1 after:w-24 after:h-1 after:bg-[var(--pbs-royal)]">Memory Wall</h2>
    <p class="text-slate-600 mt-2">Share a short story or photo from your Tau journey. Submissions are moderated before appearing.</p>
    <form id="memoryForm" class="mt-6 grid md:grid-cols-2 gap-6">
      <div>
        <label class="block text-sm font-medium">Your Name</label>
        <input name="m_name" required class="mt-1 w-full rounded-xl border-[var(--sigma-gray)]" />
      </div>
      <div>
        <label class="block text-sm font-medium">Email</label>
        <input type="email" name="m_email" required class="mt-1 w-full rounded-xl border-[var(--sigma-gray)]" />
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-medium">Story</label>
        <textarea name="m_story" required rows="4" class="mt-1 w-full rounded-xl border-[var(--sigma-gray)]" placeholder="A favorite moment, a lesson, a laugh..."></textarea>
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-medium">Optional Photo</label>
        <input type="file" name="m_photo" accept="image/*" class="mt-1 w-full rounded-xl border-[var(--sigma-gray)]" />
      </div>
      <div class="md:col-span-2 flex items-center justify-end gap-4">
        <button type="submit" class="px-5 py-3 bg-[var(--pbs-royal)] hover:bg-[var(--pbs-royal-dark)] text-white rounded-xl shadow font-semibold">Submit Memory</button>
      </div>
      <p id="memoryMsg" class="md:col-span-2 text-sm text-slate-600"></p>
    </form>
    <div id="memoryList" class="mt-8 grid md:grid-cols-2 gap-6"></div>
  </section>

  <!-- ADMIN -->
  <section id="admin" class="max-w-6xl mx-auto px-4 py-12">
    <h2 class="text-2xl sm:text-3xl font-extrabold relative pb-2 after:content-[''] after:absolute after:left-0 after:-bottom-1 after:w-24 after:h-1 after:bg-[var(--pbs-royal)]">Admin</h2>
    <p class="text-slate-600 mt-2">Enter the admin passcode to export registrants and view submissions.</p>
    <div class="mt-4 flex flex-wrap items-center gap-3">
      <input id="adminKey" type="password" placeholder="Passcode" class="rounded-xl border-[var(--sigma-gray)]" />
      <button id="csvBtn" class="px-4 py-2 rounded-xl border border-[var(--sigma-gray)] bg-white shadow">Download CSV</button>
      <button id="refreshMemBtn" class="px-4 py-2 rounded-xl border border-[var(--sigma-gray)] bg-white shadow">Refresh Memories</button>
    </div>
  </section>

  <footer class="border-t border-[var(--sigma-gray)]">
    <div class="max-w-6xl mx-auto px-4 py-8 text-sm text-slate-600 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="assets/charter members.jpg" alt="Charter Members" class="w-10 h-10 object-cover rounded-full ring-2 ring-white shadow" />
        <span>© 2025 Tau Chapter Centennial Homecoming</span>
      </div>
      <a href="#register" class="font-semibold">Register</a>
    </div>
  </footer>

  <!-- LIVE ticket URL (global override if set) -->
  <script>
    // If you prefer to manage this in Netlify env, set KPA_URL_GLOBAL there and remove this line.
    window.KPA_URL_GLOBAL = window.KPA_URL_GLOBAL || "https://tickets.kentuckyperformingarts.org/25109?queueittoken=e_tnewsafetynet~q_f776dc3a-87d4-4387-bc3e-2d2c688876ab~ts_1756080273~ce_true~rt_safetynet~h_c273baadcb1d19cc4b81c72b2d43a0742b038083f7ebb8cfa53caa1d65633c7a";
  </script>

  <!-- Success/Cancel toast script -->
  <script>
  (function(){
    function showToast(msg, ok=true){
      var root = document.getElementById('toast-root');
      if(!root){
        root = document.createElement('div');
        root.id = 'toast-root';
        root.className = 'fixed top-4 right-4 z-50 space-y-2';
        document.body.appendChild(root);
      }
      var div = document.createElement('div');
      div.className = (ok ? 'bg-green-600 text-white shadow rounded-xl px-4 py-3'
                          : 'bg-amber-600 text-white shadow rounded-xl px-4 py-3');
      div.textContent = msg;
      root.appendChild(div);
      setTimeout(function(){ div.remove(); }, 6000);
    }
    try {
      var params = new URLSearchParams(window.location.search);
      if(params.get('success') === '1'){
        showToast('Registration complete! Check your email for confirmation.', true);
      } else if(params.get('canceled') === '1'){
        showToast('Checkout canceled. You can try again anytime.', false);
      }
    } catch(e){}
  })();
  </script>

  <script>
    // ---------- KPA Ticket Link (available Sept 20) ----------
    const kpaButton = document.getElementById('kpaButton');
    const kpaHelper = document.getElementById('kpaHelper');
    const KPA_URL = (typeof KPA_URL_GLOBAL !== 'undefined' && KPA_URL_GLOBAL) || '';

    function enableKPALinkWhenAvailable() {
      const now = new Date();
      const liveDate = new Date('2025-09-20T05:00:00Z'); // 00:00 CDT == 05:00Z
      const linkEl = document.getElementById('kpaLink');

      if (now >= liveDate && KPA_URL) {
        kpaButton.disabled = false;
        kpaButton.textContent = 'Buy Stepshow Tickets';
        kpaHelper.textContent = 'Tickets now available via Kentucky Performing Arts.';
        kpaButton.addEventListener('click', () => window.open(KPA_URL, '_blank'));
        if (linkEl) { linkEl.href = KPA_URL; linkEl.classList.remove('hidden'); linkEl.style.display=''; }
      } else {
        kpaButton.disabled = true;
        if (linkEl) { linkEl.classList.add('hidden'); linkEl.style.display='none'; }
      }
    }
    enableKPALinkWhenAvailable();

    // ---------- Registration + Stripe Checkout ----------
    const form = document.getElementById('regForm');
    const msg = document.getElementById('formMsg');
    const submitBtn = document.getElementById('submitBtn');

    async function uploadPhotoIfAny(file) {
      if (!file) return { url: '' };
      const fd = new FormData();
      fd.append('file', file);
      const resp = await fetch('/.netlify/functions/upload_photo', { method: 'POST', body: fd });
      if (!resp.ok) throw new Error('Photo upload failed');
      return resp.json(); // { url }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = '';
      submitBtn.disabled = true;

      try {
        const data = new FormData(form);
        const name = data.get('name').toString().trim();
        const email = data.get('email').toString().trim();
        const phone = data.get('phone').toString().trim();
        const yearJoined = Number(data.get('yearJoined'));
        const website = data.get('website'); // honeypot
        const optInPublic = data.get('optInPublic') === 'on';
        const photoFile = data.get('photo');

        let photoUrl = '';
        if (photoFile && photoFile.size > 0) {
          const up = await uploadPhotoIfAny(photoFile);
          photoUrl = up.url || '';
        }

        const resp = await fetch('/.netlify/functions/create_checkout_session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, phone, yearJoined, photoUrl, website, optInPublic })
        });
        if (!resp.ok) throw new Error('Checkout error');
        const { url } = await resp.json();
        window.location.href = url; // Redirect to Stripe Checkout
      } catch (err) {
        console.error(err);
        msg.textContent = 'Something went wrong. Please try again.';
        submitBtn.disabled = false;
      }
    });

    // ---------- Roster Rendering (group by decade -> year) ----------
    const rosterWrap = document.getElementById('rosterWrap');
    const refreshBtn = document.getElementById('refreshBtn');

    function groupByDecadeAndYear(list) {
      const groups = {};
      for (const r of list) {
        const y = Number(r.yearJoined);
        const decadeStart = Math.floor(y / 10) * 10;
        const dKey = `${decadeStart}s`;
        if (!groups[dKey]) groups[dKey] = {};
        if (!groups[dKey][y]) groups[dKey][y] = [];
        if (r.optInPublic === false) continue;
        groups[dKey][y].push(r);
      }
      return groups;
    }

    function renderRoster(list) {
      const groups = groupByDecadeAndYear(list);
      const decades = Object.keys(groups).sort((a,b)=>parseInt(b)-parseInt(a)); // newest first
      rosterWrap.innerHTML = '';
      if (decades.length === 0) {
        rosterWrap.innerHTML = '<div class="text-slate-600">No registrations yet.</div>';
        return;
      }
      for (const d of decades) {
        const years = Object.keys(groups[d]).map(Number).sort((a,b)=>a-b);
        const col = document.createElement('div');
        col.className = 'bg-white rounded-2xl shadow p-6 ring-1 ring-[var(--sigma-gray)]';
        col.innerHTML = `<h3 class="text-xl font-bold">${d}</h3>`;
        for (const y of years) {
          const people = groups[d][y];
          const items = people
            .sort((a,b)=>a.name.localeCompare(b.name))
            .map(p => `
              <li class="flex items-center gap-3 py-1">
                ${p.photoUrl ? `<img src="${p.photoUrl}" class="w-8 h-8 rounded-full object-cover" alt="${p.name}" />` : ''}
                <span class="font-medium">${p.name}</span>
                <span class="text-xs text-slate-500">(${y})</span>
              </li>
            `).join('');
          const ul = `
            <div class="mt-4">
              <div class="text-sm font-semibold text-slate-700">${y}</div>
              <ul class="mt-1 text-sm">${items}</ul>
            </div>`;
          col.insertAdjacentHTML('beforeend', ul);
        }
        rosterWrap.appendChild(col);
      }
    }

    async function loadRoster() {
      try {
        rosterWrap.innerHTML = '<div class="text-slate-600">Loading roster…</div>';
        const resp = await fetch('/.netlify/functions/list_registrants');
        if (!resp.ok) throw new Error('Roster load failed');
        const data = await resp.json(); // { registrants: [...] }
        renderRoster(data.registrants || []);
      } catch (e) {
        rosterWrap.innerHTML = '<div class="text-slate-600">Unable to load roster at this time.</div>';
      }
    }

    refreshBtn.addEventListener('click', loadRoster);
    loadRoster();

    // ----- Memory Wall -----
    async function uploadMemoryPhotoIfAny(file) {
      if (!file) return { url: '' };
      const fd = new FormData(); fd.append('file', file);
      const resp = await fetch('/.netlify/functions/upload_photo', { method: 'POST', body: fd });
      if (!resp.ok) throw new Error('Photo upload failed');
      return resp.json();
    }

    const memoryForm = document.getElementById('memoryForm');
    const memoryMsg = document.getElementById('memoryMsg');
    const memoryList = document.getElementById('memoryList');

    async function loadMemories() {
      if (memoryList) { memoryList.innerHTML = '<div class="text-slate-600">Loading memories…</div>'; }
      try {
        const resp = await fetch('/.netlify/functions/list_memories');
        if (!resp.ok) throw new Error('Load failed');
        const data = await resp.json(); // { memories: [...] }
        memoryList.innerHTML = (data.memories || []).map(m => `
          <div class="bg-white rounded-2xl shadow p-6 ring-1 ring-[var(--sigma-gray)]">
            ${m.photoUrl ? `<img src="${m.photoUrl}" class="w-full h-48 object-cover rounded-xl mb-4" />` : ''}
            <div class="font-semibold">${m.name}</div>
            <div class="text-sm text-slate-500">${new Date(m.createdAt).toLocaleDateString()}</div>
            <p class="mt-2 text-slate-700 whitespace-pre-wrap">${m.story}</p>
          </div>`).join('');
      } catch (e) { memoryList.innerHTML = '<div class="text-slate-600">Unable to load memories right now.</div>'; }
    }

    if (memoryForm) {
      memoryForm.addEventListener('submit', async (e) => {
        e.preventDefault(); memoryMsg.textContent = '';
        const fd = new FormData(memoryForm);
        try {
          let photoUrl = '';
          const file = fd.get('m_photo');
          if (file && file.size > 0) { const up = await uploadMemoryPhotoIfAny(file); photoUrl = up.url || ''; }
          const payload = { name: fd.get('m_name'), email: fd.get('m_email'), story: fd.get('m_story'), photoUrl };
          const resp = await fetch('/.netlify/functions/submit_memory', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          if (!resp.ok) throw new Error('Submit failed');
          memoryMsg.textContent = 'Thanks! Your memory is pending approval.';
          memoryForm.reset();
          loadMemories();
        } catch (err) { memoryMsg.textContent = 'Something went wrong. Please try again.'; }
      });
    }
    loadMemories();

    // ----- Admin tools -----
    const csvBtn = document.getElementById('csvBtn');
    const refreshMemBtn = document.getElementById('refreshMemBtn');
    function adminKey() { return document.getElementById('adminKey')?.value || ''; }
    if (csvBtn) {
      csvBtn.addEventListener('click', async () => {
        const resp = await fetch('/.netlify/functions/export_csv', { headers: { 'x-admin-key': adminKey() } });
        if (!resp.ok) { alert('Unauthorized or error.'); return; }
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'registrants.csv'; a.click();
        URL.revokeObjectURL(url);
      });
    }
    if (refreshMemBtn) { refreshMemBtn.addEventListener('click', loadMemories); }
  </script>
</body>
</html>
