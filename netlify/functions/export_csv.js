// netlify/functions/export_csv.js
const common = require('./_common.cjs');
exports.handler = async (event) => { try { const admin = event.headers['x-admin-key'] || event.headers['X-Admin-Key']; if (!common.auth(admin)) return common.bad(401, 'Unauthorized'); const db = await common.stores.registrants(); const rows = await db.getJSON(); const cols = ['name','email','phone','yearJoined','tshirtSize','optInPublic','packageName','packageAmount','ts']; const csv = [cols.join(',')].concat(rows.map(r=>cols.map(c=>JSON.stringify(r[c] ?? '')).join(','))).join('\n'); return { statusCode:200, headers:{ 'Content-Type':'text/csv', 'Content-Disposition':'attachment; filename="registrants.csv"' }, body: csv }; } catch (e) { return common.bad(500, e.message || 'error'); } };